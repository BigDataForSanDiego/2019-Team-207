import pandas as pd
from pandas import ExcelWriter
import html5lib
import numpy as np
from selenium import webdriver
from selenium.webdriver.common.by import By
from selenium.common.exceptions import NoSuchElementException
from selenium.common.exceptions import WebDriverException
from selenium.webdriver.common.keys import Keys
from selenium.webdriver.chrome.options import Options
from selenium.webdriver.support.ui import Select
import winsound
import time

class craiglistscrape:
    def __init__(self, starting_url):
        self.starting_url = starting_url
        self.browser = webdriver.Chrome("C:/Users/mting/Documents/chromedriver.exe", chrome_options=self.set_options())
        self.writer = pd.ExcelWriter('PlayerExport.xlsx')

    def set_options(self):
        path_to_extension = "C:/Users/mting/Desktop/3.31.2_0"
        chrome_options = Options()
        chrome_options.add_argument('load-extension=' + path_to_extension)
        return(chrome_options)

    def gethomeinfo(self):
        self.browser.create_options()
        self.browser.get(self.starting_url)
        for index in range(len(self.browser.find_elements_by_xpath("//li[@class='result-row']"))):
            price = self.browser.find_elements_by_xpath("//li[@class='result-row']")[index].text
            price = price.splitlines()[0]
            if(len(price) > 6):
                start = price.index("$")
                end = price[start:].index(" ")
                price = float(price[start+1:start + end])
            else:
                price = float(price[1:]) 
            self.browser.find_elements_by_xpath("//a[@class='result-title hdrlnk']")[index].click()
            map_att = self.browser.find_element_by_xpath("//div[@class='mapbox']")
            lat = float(map_att.find_element_by_css_selector("div").get_attribute('data-latitude'))
            lng = float(map_att.find_element_by_css_selector("div").get_attribute('data-longitude'))
            attributes = self.browser.find_elements_by_xpath("//p[@class='attrgroup']")[0].text.lower().split()
            bedrooms = -1
            bathrooms = -1 
            sqrft = -1 
            for item in attributes:
                if 'br' in item: 
                    bedrooms = float(item[:-2])
                elif "ba" in item: 
                    bathrooms = float(item[:-2])
                elif "ft2" in item: 
                    sqrft = float(item[:-3]) 
            if bedrooms > 0 and bathrooms > 0 and sqrft > 0: 
                print("${} {}:sqrft {}:bed {}:bath {}:lat {}:lng".format(price, sqrft, bedrooms, bathrooms, lat, lng))
            self.browser.execute_script("window.history.go(-1)")
            
                




test = craiglistscrape("https://sandiego.craigslist.org/d/apts-housing-for-rent/search/apa")
test.gethomeinfo()